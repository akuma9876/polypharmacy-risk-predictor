<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Polypharmacy Risk AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        /* Select2 container */
        .select2-container {
            width: 100% !important;
        }
        .select2-container--default .select2-selection--multiple {
            background-color: #334155 !important;
            border: 1px solid #475569 !important;
            border-radius: 0.5rem !important;
            padding: 0.375rem !important;
            min-height: 3rem !important;
            cursor: text !important;
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: center !important;
        }
        /* Fix the rendered selection area */
        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: center !important;
            gap: 0.25rem !important;
            padding: 0 !important;
            line-height: 1.75rem !important;
        }
        /* Selected drug chips */
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #10b981 !important;
            border: none !important;
            color: white !important;
            padding: 0.25rem 0.5rem !important;
            border-radius: 0.375rem !important;
            margin: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            flex-direction: row !important;
            gap: 0.5rem !important;
            font-size: 0.875rem !important;
            line-height: 1.25rem !important;
            height: 1.75rem !important;
        }
        /* Remove button styling - at the end */
        .select2-container--default .select2-selection--multiple .select2-selection__choice__display {
            padding: 0 !important;
            margin: 0 !important;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white !important;
            font-size: 1rem !important;
            font-weight: bold !important;
            cursor: pointer !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            order: 2 !important;
            position: relative !important;
            left: auto !important;
            top: auto !important;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
            color: #fecaca !important;
            background: transparent !important;
        }
        /* Search input inside the selection box */
        .select2-container--default .select2-search--inline {
            margin: 0 !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
        }
        .select2-container--default .select2-search--inline .select2-search__field {
            background-color: transparent !important;
            color: white !important;
            margin: 0 !important;
            padding: 0 0.25rem !important;
            height: 1.75rem !important;
            line-height: 1.75rem !important;
            font-size: 0.875rem !important;
        }
        .select2-container--default .select2-search--inline .select2-search__field::placeholder {
            color: #94a3b8 !important;
        }
        /* Dropdown styling - connected to search bar */
        .select2-container--open .select2-selection--multiple {
            border-bottom-left-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
        }
        .select2-dropdown {
            background-color: #1e293b !important;
            border: 1px solid #475569 !important;
            border-top: none !important;
            border-radius: 0 0 0.5rem 0.5rem !important;
            margin-top: -1px !important;
        }
        .select2-search--dropdown {
            padding: 0.5rem !important;
            background-color: #1e293b !important;
        }
        .select2-search--dropdown .select2-search__field {
            background-color: #0f172a !important;
            border: 1px solid #475569 !important;
            color: white !important;
            border-radius: 0.375rem !important;
            padding: 0.5rem !important;
        }
        /* Results list with custom scrollbar */
        .select2-results {
            max-height: 250px !important;
            overflow-y: auto !important;
            background-color: #1e293b !important;
        }
        .select2-results::-webkit-scrollbar {
            width: 8px !important;
        }
        .select2-results::-webkit-scrollbar-track {
            background: #0f172a !important;
            border-radius: 0 0 0.5rem 0 !important;
        }
        .select2-results::-webkit-scrollbar-thumb {
            background: #475569 !important;
            border-radius: 4px !important;
        }
        .select2-results::-webkit-scrollbar-thumb:hover {
            background: #64748b !important;
        }
        .select2-results__option {
            color: white !important;
            padding: 0.5rem 1rem !important;
            background-color: #1e293b !important;
        }
        .select2-results__option--highlighted {
            background-color: #10b981 !important;
        }
        .select2-results__option--selected {
            background-color: #0d9488 !important;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__placeholder {
            color: #94a3b8 !important;
        }
        /* Fix focus state */
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #10b981 !important;
            outline: none !important;
        }
        .select2-container--default.select2-container--open .select2-selection--multiple {
            border-color: #10b981 !important;
        }
        /* Clear button styling */
        .select2-selection__clear {
            color: #94a3b8 !important;
            font-size: 1.25rem !important;
            margin-right: 0.5rem !important;
        }
        .select2-selection__clear:hover {
            color: white !important;
        }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans">
    <div class="max-w-4xl mx-auto py-12">
        <header class="mb-12 border-b border-slate-700 pb-6">
            <h1 class="text-4xl font-bold text-emerald-400">Polypharmacy Risk Predictor</h1>
            <p class="text-slate-400 mt-2">GNN-powered analysis of 3-drug cocktail toxicity.</p>
        </header>

        <section class="bg-slate-800 p-8 rounded-xl shadow-2xl">
            <label class="block mb-4 text-sm font-medium">Select Drugs (type to search):</label>
            <select id="drugSelect" multiple="multiple" class="w-full mb-4" style="width: 100%;">
            </select>
            <button id="runButton" onclick="getRisk(event)" class="bg-emerald-600 hover:bg-emerald-500 transition-colors w-full py-3 rounded-lg font-bold">
                Run Simulation
            </button>
        </section>

        <section id="resultsSection" class="mt-12 hidden">
            <h2 class="text-2xl mb-6 font-semibold">Risk Analysis Results</h2>
            <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>
        </section>
    </div>

    <script>
        let allDrugs = [];

        // Load drugs on page load
        async function loadDrugs() {
            try {
                const response = await fetch('/get_drugs');
                allDrugs = await response.json();
                
                const select = $('#drugSelect');
                allDrugs.forEach(drug => {
                    const option = new Option(drug.name + ' (' + drug.cid + ')', drug.cid, false, false);
                    select.append(option);
                });

                // Initialize Select2 with search functionality
                select.select2({
                    placeholder: 'Type to search and select drugs...',
                    allowClear: true,
                    width: '100%',
                    theme: 'default',
                    closeOnSelect: false,
                    selectionCssClass: 'select2-selection-custom'
                });
                
                // Re-focus the search input after selection
                select.on('select2:select', function() {
                    setTimeout(function() {
                        select.select2('open');
                    }, 0);
                });
                
                // Keep dropdown open while selecting multiple
                select.on('select2:close', function() {
                    $('.select2-search__field').focus();
                });
            } catch (error) {
                console.error('Error loading drugs:', error);
                alert('Error loading drugs. Please check the console and refresh the page.');
            }
        }

        async function getRisk(event) {
            try {
                const selectedCids = $('#drugSelect').val();
                
                console.log('Selected drugs:', selectedCids);
                
                if (!selectedCids || selectedCids.length === 0) {
                    alert('Please select at least one drug');
                    return;
                }
                
                // Show loading state
                const button = event ? event.target : document.getElementById('runButton');
                const originalText = button.textContent;
                button.textContent = 'Analyzing...';
                button.disabled = true;
                
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({drug_ids: selectedCids})
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Prediction results:', data);
                displayResults(data);
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
            } catch (error) {
                console.error('Error getting predictions:', error);
                alert('Error getting predictions: ' + error.message);
                // Reset button
                const button = event ? event.target : document.getElementById('runButton');
                button.textContent = 'Run Simulation';
                button.disabled = false;
            }
        }

        function displayResults(data) {
            const grid = document.getElementById('resultsGrid');
            const section = document.getElementById('resultsSection');
            grid.innerHTML = '';
            section.classList.remove('hidden');

            for (const [effect, score] of Object.entries(data)) {
                const color = score > 0.7 ? 'text-red-400' : 'text-emerald-400';
                grid.innerHTML += `
                    <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                        <p class="text-sm text-slate-400 uppercase tracking-wider">${effect}</p>
                        <p class="text-3xl font-bold ${color}">${(score * 100).toFixed(1)}%</p>
                    </div>
                `;
            }
        }

        // Load drugs when page loads
        window.addEventListener('DOMContentLoaded', loadDrugs);
    </script>
</body>
</html>